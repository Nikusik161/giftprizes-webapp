<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftPrises - NFT Подарки</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --text: #ffffff;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-light {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --accent: #ec4899;
            --text: #1f2937;
            --bg: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .theme-dark {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --text: #f3f4f6;
            --bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-switcher {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: var(--text);
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        .theme-switcher:hover {
            transform: rotate(180deg) scale(1.1);
            animation: none;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 10px;
            display: inline-block;
            animation: bounce 2s infinite, glow 3s infinite alternate;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textShine 3s ease-in-out infinite;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 30px;
            animation: fadeIn 2s ease-out;
        }

        /* Navigation Grid */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        .nav-card:nth-child(1) { animation-delay: 0.1s; }
        .nav-card:nth-child(2) { animation-delay: 0.2s; }
        .nav-card:nth-child(3) { animation-delay: 0.3s; }
        .nav-card:nth-child(4) { animation-delay: 0.4s; }

        .nav-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .nav-card:hover::before {
            left: 100%;
        }

        .nav-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .nav-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        .nav-card:nth-child(1) .nav-icon { animation-delay: 0s; }
        .nav-card:nth-child(2) .nav-icon { animation-delay: 0.5s; }
        .nav-card:nth-child(3) .nav-icon { animation-delay: 1s; }
        .nav-card:nth-child(4) .nav-icon { animation-delay: 1.5s; }

        .nav-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .nav-desc {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        .back-button {
            background: var(--card-bg);
            border: none;
            color: var(--text);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            animation: slideInLeft 0.5s ease-out;
        }

        .back-button:hover {
            transform: translateX(-5px);
        }

        /* Models Grid */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .model-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            animation: zoomIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .model-card:hover::before {
            transform: translateX(100%);
        }

        .model-card:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--accent);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .model-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--card-bg), rgba(255,255,255,0.15));
            animation: pulse 2s infinite;
        }

        .gift-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .model-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .model-price {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
            animation: glow 2s infinite alternate;
        }

        /* Search Screen */
        .search-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin: 20px 0;
            animation: slideUp 0.6s ease-out;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 15px;
            transition: var(--transition);
            border: 2px solid transparent;
            animation: slideInRight 0.5s ease-out;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.3);
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
            animation: pulse 2s infinite;
        }

        .theme-light .search-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .budget-slider {
            width: 100%;
            margin: 20px 0;
            animation: slideInLeft 0.5s ease-out;
        }

        .budget-value {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 10px 0;
            animation: countUp 1s ease-out;
        }

        /* Results */
        .results-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            animation: slideUp 0.5s ease-out;
        }

        .result-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-model {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
            animation: glow 2s infinite alternate;
        }

        .result-details {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .action-btn:hover {
            transform: scale(1.05);
            animation: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .action-btn.secondary {
            background: var(--card-bg);
            color: var(--text);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Filters */
        .filters {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .sort-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .sort-btn {
            padding: 10px;
            border: none;
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Purchase Flow */
        .purchase-flow {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--card-bg);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .step.active .step-circle {
            background: var(--primary);
            transform: scale(1.1);
        }

        .step-label {
            font-size: 0.8rem;
            text-align: center;
        }

        .payment-info {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .address-box {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .copy-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
        }

        .status-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        /* Features */
        .features {
            margin: 30px 0;
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease-out;
        }

        .feature-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            animation: bounce 2s infinite;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        /* Gift Image */
        .gift-image-large {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 15px;
            margin: 0 auto 20px;
            display: block;
            border: 3px solid rgba(255,255,255,0.2);
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-10px) scale(1.1); }
            60% { transform: translateY(-5px) scale(1.05); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6)); }
        }

        @keyframes textShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes countUp {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .nav-grid, .models-grid {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .logo {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Главный экран -->
    <div class="container">
        <div class="screen active" id="main-screen">
            <div class="header">
                <button class="theme-switcher" onclick="switchTheme()">
                    <i class="fas fa-palette"></i>
                </button>
                
                <div class="logo">🎁</div>
                <h1 class="title">GiftPrises</h1>
                <p class="subtitle">Твой мир уникальных NFT подарков</p>
            </div>

            <div class="nav-grid">
                <div class="nav-card" onclick="loadRealGifts()">
                    <div class="nav-icon">📚</div>
                    <div class="nav-title">Каталог NFT</div>
                    <div class="nav-desc">Реальные подарки с маркетплейсов</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('search-screen')">
                    <div class="nav-icon">🔍</div>
                    <div class="nav-title">Поиск</div>
                    <div class="nav-desc">Найди идеальный подарок</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('budget-screen')">
                    <div class="nav-icon">💰</div>
                    <div class="nav-title">Бюджет</div>
                    <div class="nav-desc">Установи лимит</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('filters-screen')">
                    <div class="nav-icon">🎯</div>
                    <div class="nav-title">Фильтры</div>
                    <div class="nav-desc">Расширенный поиск</div>
                </div>
            </div>

            <div class="features">
                <div class="feature">
                    <span class="feature-icon">⚡</span>
                    Мгновенная доставка NFT подарков в Telegram
                </div>
                <div class="feature">
                    <span class="feature-icon">🎨</span>
                    Реальные NFT с маркетплейсов по лучшим ценам
                </div>
                <div class="feature">
                    <span class="feature-icon">💫</span>
                    Подарки для себя и друзей с автоматической доставкой
                </div>
                <div class="feature">
                    <span class="feature-icon">🛡️</span>
                    Безопасные сделки через TON блокчейн
                </div>
            </div>

            <div class="footer">
                Powered by Telegram WebApp • GiftPrises 2024
            </div>
        </div>

        <!-- Экран каталога -->
        <div class="screen" id="catalog-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px; animation: textShine 3s infinite;">📚 Каталог NFT Подарков</h2>
            
            <div class="models-grid" id="catalog-grid">
                <!-- Каталог моделей будет загружен -->
            </div>
        </div>

        <!-- Экран поиска -->
        <div class="screen" id="search-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px; animation: textShine 3s infinite;">🔍 Поиск NFT подарков</h2>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🎭 Введите название модели..." id="search-input">
                <input type="text" class="search-input" placeholder="🌄 Введите фон (опционально)..." id="backdrop-input">
                <input type="text" class="search-input" placeholder="✨ Введите узор (опционально)..." id="symbol-input">
                
                <div class="budget-value">💰 Бюджет: <span id="budget-amount">50</span> TON</div>
                <input type="range" class="budget-slider" min="10" max="200" value="50" id="budget-slider">
                
                <button class="action-btn" onclick="performSearch()" style="width: 100%;">
                    🔍 Найти NFT подарки
                </button>

                <button class="action-btn secondary" onclick="clearSearch()" style="width: 100%; margin-top: 10px;">
                    🗑️ Очистить поиск
                </button>
            </div>

            <div class="results-grid" id="search-results">
                <!-- Результаты поиска -->
            </div>
        </div>

        <!-- Экран бюджета -->
        <div class="screen" id="budget-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px; animation: textShine 3s infinite;">💰 Установи бюджет</h2>
            
            <div class="search-container">
                <div class="budget-value" style="font-size: 2rem; color: var(--accent);">
                    <span id="budget-display">50</span> TON
                </div>
                <input type="range" class="budget-slider" min="10" max="200" value="50" id="budget-setter">
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="setBudget(30)">30 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(50)">50 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(100)">100 TON</button>
                </div>
                
                <button class="action-btn" onclick="saveBudget()" style="width: 100%; margin-top: 20px;">
                    💾 Сохранить бюджет
                </button>
            </div>
        </div>

        <!-- Экран фильтров -->
        <div class="screen" id="filters-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px; animation: textShine 3s infinite;">🎯 Расширенные фильтры</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">🔍 Поиск по названию</label>
                    <input type="text" class="search-input" placeholder="Введите название..." id="filter-search-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">💰 Бюджет: <span id="filter-budget-value">50</span> TON</label>
                    <input type="range" class="budget-slider" min="1" max="200" value="50" id="filter-budget-slider">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">📊 Сортировка</label>
                    <div class="sort-buttons">
                        <button class="sort-btn active" onclick="setSort('price_asc')">Сначала дешевые</button>
                        <button class="sort-btn" onclick="setSort('price_desc')">Сначала дорогие</button>
                        <button class="sort-btn" onclick="setSort('rarity')">По редкости</button>
                        <button class="sort-btn" onclick="setSort('name')">По названию</button>
                    </div>
                </div>
                
                <button class="action-btn" onclick="performAdvancedSearch()" style="width: 100%;">
                    🚀 Применить фильтры
                </button>
            </div>
        </div>

        <!-- Экран покупки -->
        <div class="screen" id="purchase-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px; animation: textShine 3s infinite;">💳 Оформление покупки</h2>
            
            <div class="purchase-flow">
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Выбор</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Получатель</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Оплата</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Готово</div>
                    </div>
                </div>

                <div id="purchase-content">
                    <!-- Контент покупки будет обновляться -->
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-text">Загружаем NFT подарки...</p>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let currentTheme = 'default';
        let selectedGift = null;
        let userBudget = 50;
        let currentSort = 'price_asc';
        let currentPurchaseStep = 1;
        let recipientUsername = '';
        let purchaseId = '';
        let realGifts = [];
        let paymentCheckInterval = null;

        // Инициализация приложения
        function initApp() {
            tg.expand();
            tg.enableClosingConfirmation();
            updateBudgetDisplays();
            
            // Загружаем реальные данные о подарках
            loadRealGiftsData();
        }

        // Загрузка реальных данных о подарках
        async function loadRealGiftsData() {
            showLoading(true, "🔄 Загружаем актуальные данные с маркетплейсов...");
            
            try {
                // Отправляем запрос на получение реальных данных
                tg.sendData(JSON.stringify({
                    action: 'get_gifts_data'
                }));
                
                // В реальном приложении здесь будет ответ от бота с данными
                // Для демонстрации используем имитацию
                setTimeout(() => {
                    // Имитация реальных данных
                    realGifts = generateRealGiftsData();
                    showLoading(false);
                    showScreen('catalog-screen');
                    displayRealGifts(realGifts);
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                showLoading(false);
                showStatusMessage('Ошибка загрузки данных. Попробуйте позже.', 'error');
            }
        }

        // Генерация имитации реальных данных
        function generateRealGiftsData() {
            const giftNames = [
                "Artisan Brick", "Astral Shard", "B-Day Candle", "Berry Box", "Big Year", 
                "Bonded Ring", "Bow Tie", "Bunny Milffin", "Candy Cane", "Clover Pin",
                "Cookie Heart", "Crystal Ball", "Cupid Charm", "Desk Calendar", "Diamond Ring",
                "Durov's Cap", "Easter Egg", "Electric Skull", "Eternal Candle", "Eternal Rose",
                "Evil Eye", "Flying Broom", "Fresh Socks", "Gem Signet", "Genie Lamp"
            ];
            
            return giftNames.map((name, index) => {
                const basePrice = Math.floor(Math.random() * 50) + 20;
                const totalPrice = basePrice * 1.05; // +5% комиссия
                
                return {
                    id: `gift_${index + 1}`,
                    name: name,
                    base_price: basePrice,
                    total_price: Math.round(totalPrice * 100) / 100,
                    image_url: `https://api.portals.io/gifts/${index + 1}/image`,
                    market: 'Portals',
                    attributes: {
                        model: name,
                        backdrop: ['Любой фон', 'Звездный', 'Городской', 'Природный'][Math.floor(Math.random() * 4)],
                        symbol: ['Любой узор', 'Звезды', 'Цветы', 'Геометрия'][Math.floor(Math.random() * 4)]
                    },
                    is_transferable: true,
                    rarity: ['common', 'rare', 'epic', 'legendary'][Math.floor(Math.random() * 4)]
                };
            });
        }

        // Отображение реальных подарков
        function displayRealGifts(gifts) {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '';
            
            gifts.forEach(gift => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.onclick = () => selectGift(gift);
                
                card.innerHTML = `
                    <img src="${gift.image_url}" alt="${gift.name}" class="gift-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iMTAiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPgo8dGV4dCB4PSI0MCIgeT0iNDUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEyIj4kTkZUPzwvdGV4dD4KPC9zdmc+'">
                    <div class="model-name">${gift.name}</div>
                    <div class="model-price">${gift.total_price} TON</div>
                    <div style="font-size: 0.7rem; opacity: 0.6; margin-top: 5px;">
                        ${getRarityText(gift.rarity)} • ${gift.market}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Переключение темы
        function switchTheme() {
            const body = document.body;
            if (currentTheme === 'default') {
                body.classList.add('theme-light');
                currentTheme = 'light';
            } else if (currentTheme === 'light') {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                currentTheme = 'dark';
            } else {
                body.classList.remove('theme-dark');
                currentTheme = 'default';
            }
        }

        // Показать экран
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Загрузка реальных подарков
        function loadRealGifts() {
            showScreen('catalog-screen');
            if (realGifts.length === 0) {
                loadRealGiftsData();
            } else {
                displayRealGifts(realGifts);
            }
        }

        // Выбор подарка
        function selectGift(gift) {
            selectedGift = gift;
            showScreen('purchase-screen');
            updatePurchaseStep(1);
        }

        // Обновление шага покупки
        function updatePurchaseStep(step) {
            currentPurchaseStep = step;
            
            // Обновляем индикатор шагов
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                if (index + 1 <= step) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
            });
            
            // Обновляем контент
            const content = document.getElementById('purchase-content');
            switch(step) {
                case 1:
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">🎁 Вы выбрали:</h3>
                        <img src="${selectedGift.image_url}" alt="${selectedGift.name}" class="gift-image-large"
                             onerror="this.style.display='none'">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 5px;">${selectedGift.name}</div>
                            <div style="font-size: 1.2rem; color: var(--accent);">${selectedGift.total_price} TON</div>
                            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">
                                ${selectedGift.market} • ${getRarityText(selectedGift.rarity)}
                            </div>
                        </div>
                        <button class="action-btn" onclick="updatePurchaseStep(2)" style="width: 100%;">
                            Далее ➡️
                        </button>
                    `;
                    break;
                    
                case 2:
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">👤 Кому отправить подарок?</h3>
                        <input type="text" class="search-input" placeholder="@username или оставьте пустым для себя" id="recipient-input">
                        <div class="status-message status-info" style="display: none;" id="username-status">
                            Проверяем username...
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="action-btn secondary" onclick="updatePurchaseStep(1)">
                                ⬅️ Назад
                            </button>
                            <button class="action-btn" onclick="validateAndSetRecipient()" id="recipient-btn">
                                Проверить и продолжить ➡️
                            </button>
                        </div>
                    `;
                    break;
                    
                case 3:
                    purchaseId = 'purchase_' + Date.now();
                    const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
                    
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">💳 Оплата</h3>
                        <div class="payment-info">
                            <div style="margin-bottom: 15px;">
                                <strong>Подарок:</strong> ${selectedGift.name}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Получатель:</strong> ${recipientUsername || 'Себе'}
                            </div>
                            <div style="font-size: 1.3rem; font-weight: 600; color: var(--accent); margin-bottom: 20px;">
                                Сумма: ${selectedGift.total_price} TON
                            </div>
                            
                            <div class="address-box">
                                <strong>Адрес кошелька:</strong><br>
                                EQABC123DEF456GHI789JKL012MNO345PQR678STU
                            </div>
                            
                            <div class="address-box">
                                <strong>Memo (обязательно):</strong><br>
                                ${memo}
                            </div>
                            
                            <button class="copy-btn" onclick="copyPaymentDetails()" style="margin-right: 10px;">
                                📋 Скопировать данные
                            </button>
                            
                            <button class="copy-btn" onclick="sharePaymentDetails()">
                                📤 Поделиться
                            </button>
                        </div>
                        
                        <div class="status-message status-info" id="payment-status">
                            ⏳ Ожидаем подтверждения оплаты...
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="action-btn secondary" onclick="updatePurchaseStep(2)">
                                ⬅️ Назад
                            </button>
                            <button class="action-btn" onclick="checkPaymentStatus()" id="check-payment-btn">
                                🔄 Проверить оплату
                            </button>
                        </div>
                    `;
                    
                    // Запускаем проверку оплаты
                    startPaymentChecking();
                    break;
                    
                case 4:
                    content.innerHTML = `
                        <div style="text-align: center; padding: 30px 0;">
                            <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
                            <h3 style="margin-bottom: 15px;">Подарок отправлен!</h3>
                            <p style="margin-bottom: 25px; opacity: 0.8;">
                                <strong>${selectedGift.name}</strong> был успешно отправлен ${recipientUsername ? 'пользователю ' + recipientUsername : 'вам'}!
                            </p>
                            <div class="status-message status-success">
                                ✅ Транзакция подтверждена. Подарок доставлен.
                            </div>
                            <button class="action-btn" onclick="showScreen('main-screen')" style="width: 100%; margin-top: 20px;">
                                🏠 На главную
                            </button>
                        </div>
                    `;
                    
                    // Останавливаем проверку оплаты
                    stopPaymentChecking();
                    break;
            }
        }

        // Валидация и установка получателя
        async function validateAndSetRecipient() {
            const input = document.getElementById('recipient-input');
            const username = input.value.trim();
            const statusDiv = document.getElementById('username-status');
            const button = document.getElementById('recipient-btn');
            
            // Показываем статус
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-message status-info';
            statusDiv.innerHTML = '🔍 Проверяем username...';
            button.disabled = true;
            
            // Проверяем username
            const isValid = await validateUsername(username);
            
            if (isValid) {
                recipientUsername = username;
                statusDiv.className = 'status-message status-success';
                statusDiv.innerHTML = '✅ Username корректен';
                setTimeout(() => {
                    updatePurchaseStep(3);
                }, 1000);
            } else {
                statusDiv.className = 'status-message status-error';
                statusDiv.innerHTML = '❌ Username не найден или некорректен';
                button.disabled = false;
            }
        }

        // Валидация username
        async function validateUsername(username) {
            if (!username) {
                return true; // Пустой username - подарок себе
            }
            
            if (!username.startsWith('@')) {
                return false;
            }
            
            // В реальном приложении здесь будет запрос к Telegram API
            // Для демонстрации используем имитацию
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Имитация проверки - считаем валидными usernames длиной более 5 символов
                    resolve(username.length >= 5);
                }, 1500);
            });
        }

        // Копирование данных для оплаты
        function copyPaymentDetails() {
            const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
            const text = `Адрес: EQABC123DEF456GHI789JKL012MNO345PQR678STU\nСумма: ${selectedGift.total_price} TON\nMemo: ${memo}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showStatusMessage('Данные для оплаты скопированы в буфер обмена!', 'success');
            });
        }

        // Поделиться данными для оплаты
        function sharePaymentDetails() {
            const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
            const text = `Отправьте ${selectedGift.total_price} TON на адрес: EQABC123DEF456GHI789JKL012MNO345PQR678STU с memo: ${memo}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Оплата NFT подарка',
                    text: text
                });
            } else {
                copyPaymentDetails();
            }
        }

        // Запуск проверки оплаты
        function startPaymentChecking() {
            paymentCheckInterval = setInterval(checkPaymentStatus, 10000); // Проверка каждые 10 секунд
        }

        // Остановка проверки оплаты
        function stopPaymentChecking() {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
        }

        // Проверка статуса оплаты
        async function checkPaymentStatus() {
            const statusDiv = document.getElementById('payment-status');
            const button = document.getElementById('check-payment-btn');
            
            statusDiv.className = 'status-message status-info';
            statusDiv.innerHTML = '🔍 Проверяем статус оплаты...';
            button.disabled = true;
            
            // Имитация проверки оплаты
            const isPaid = await simulatePaymentCheck();
            
            if (isPaid) {
                statusDiv.className = 'status-message status-success';
                statusDiv.innerHTML = '✅ Оплата подтверждена! Отправляем подарок...';
                
                // Имитация процесса отправки подарка
                setTimeout(() => {
                    updatePurchaseStep(4);
                }, 2000);
            } else {
                statusDiv.className = 'status-message status-warning';
                statusDiv.innerHTML = '⏳ Оплата еще не поступила. Проверьте транзакцию.';
                button.disabled = false;
            }
        }

        // Имитация проверки оплаты
        async function simulatePaymentCheck() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // В реальном приложении здесь будет запрос к TON API
                    // Для демонстрации 30% шанс что оплата прошла
                    resolve(Math.random() < 0.3);
                }, 2000);
            });
        }

        // Поиск NFT
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const budget = userBudget;
            
            showLoading(true, "🔍 Ищем подарки...");
            
            setTimeout(() => {
                const results = realGifts.filter(gift => {
                    const matchesSearch = !searchTerm || gift.name.toLowerCase().includes(searchTerm);
                    const matchesBudget = gift.total_price <= budget;
                    return matchesSearch && matchesBudget;
                });
                
                displaySearchResults(results);
                showLoading(false);
            }, 1000);
        }

        // Отображение результатов поиска
        function displaySearchResults(results) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">😔</div>
                        <h3>Ничего не найдено</h3>
                        <p>Попробуйте изменить параметры поиска</p>
                    </div>
                `;
                return;
            }
            
            results.forEach(gift => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-model">${gift.name}</div>
                        <div class="result-price">${gift.total_price} TON</div>
                    </div>
                    <div class="result-details">
                        ${gift.market} • ${getRarityText(gift.rarity)}
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="showGiftDetails('${gift.id}')">
                            ℹ️ Подробнее
                        </button>
                        <button class="action-btn" onclick="selectGift(${JSON.stringify(gift).replace(/"/g, '&quot;')})">
                            🎁 Выбрать
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Получение текста редкости
        function getRarityText(rarity) {
            const rarityMap = {
                'common': '⚪ Обычный',
                'rare': '🔵 Редкий', 
                'epic': '💜 Эпический',
                'legendary': '⭐ Легендарный'
            };
            return rarityMap[rarity] || rarity;
        }

        // Детали подарка
        function showGiftDetails(giftId) {
            const gift = realGifts.find(g => g.id === giftId);
            if (gift) {
                tg.showPopup({
                    title: `🎁 ${gift.name}`,
                    message: `💰 Цена: ${gift.total_price} TON\n🏪 Маркет: ${gift.market}\n⭐ Редкость: ${getRarityText(gift.rarity)}\n🎨 Особенности: ${gift.attributes.backdrop}, ${gift.attributes.symbol}`,
                    buttons: [{ type: 'ok' }]
                });
            }
        }

        // Очистка поиска
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('backdrop-input').value = '';
            document.getElementById('symbol-input').value = '';
            document.getElementById('budget-slider').value = 50;
            userBudget = 50;
            updateBudgetDisplays();
            document.getElementById('search-results').innerHTML = '';
        }

        // Установка бюджета
        function setBudget(amount) {
            userBudget = amount;
            document.getElementById('budget-setter').value = amount;
            updateBudgetDisplays();
        }

        // Сохранение бюджета
        function saveBudget() {
            showStatusMessage(`Бюджет установлен: ${userBudget} TON`, 'success');
            setTimeout(() => showScreen('main-screen'), 1000);
        }

        // Обновление отображения бюджета
        function updateBudgetDisplays() {
            document.getElementById('budget-amount').textContent = userBudget;
            document.getElementById('budget-display').textContent = userBudget;
            document.getElementById('filter-budget-value').textContent = userBudget;
            document.getElementById('filter-budget-slider').value = userBudget;
        }

        // Установка сортировки
        function setSort(sortType) {
            currentSort = sortType;
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Расширенный поиск
        function performAdvancedSearch() {
            const searchTerm = document.getElementById('filter-search-input').value.toLowerCase();
            const budget = parseInt(document.getElementById('filter-budget-slider').value);
            
            let results = realGifts.filter(gift => {
                const matchesSearch = !searchTerm || gift.name.toLowerCase().includes(searchTerm);
                const matchesBudget = gift.total_price <= budget;
                return matchesSearch && matchesBudget;
            });
            
            // Сортировка
            switch(currentSort) {
                case 'price_asc':
                    results.sort((a, b) => a.total_price - b.total_price);
                    break;
                case 'price_desc':
                    results.sort((a, b) => b.total_price - a.total_price);
                    break;
                case 'name':
                    results.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'rarity':
                    const rarityOrder = { 'legendary': 4, 'epic': 3, 'rare': 2, 'common': 1 };
                    results.sort((a, b) => rarityOrder[b.rarity] - rarityOrder[a.rarity]);
                    break;
            }
            
            showScreen('search-screen');
            displaySearchResults(results);
        }

        // Показать/скрыть загрузку
        function showLoading(show, text = "Загружаем NFT подарки...") {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('loading-text').textContent = text;
        }

        // Показать статус сообщение
        function showStatusMessage(message, type = 'info') {
            const tempDiv = document.createElement('div');
            tempDiv.className = `status-message status-${type}`;
            tempDiv.textContent = message;
            tempDiv.style.position = 'fixed';
            tempDiv.style.top = '20px';
            tempDiv.style.left = '50%';
            tempDiv.style.transform = 'translateX(-50%)';
            tempDiv.style.zIndex = '1000';
            tempDiv.style.maxWidth = '90%';
            
            document.body.appendChild(tempDiv);
            
            setTimeout(() => {
                tempDiv.remove();
            }, 3000);
        }

        // Слушатели событий
        document.getElementById('budget-slider').addEventListener('input', function() {
            userBudget = parseInt(this.value);
            document.getElementById('budget-amount').textContent = userBudget;
        });

        document.getElementById('budget-setter').addEventListener('input', function() {
            userBudget = parseInt(this.value);
            document.getElementById('budget-displaybudget-display').textContent = userBudget;
        });

        document.getElementById('').textContent = userBudget;
        });

        document.getElementById('filter-budget-slider').addEventListener('inputfilter-budget-slider').addEventListener('input', function() {
            document.getElementById', function() {
            document.getElementById('filter-budget('filter-budget-value').textContent = this-value').textContent = this.value;
        });

        // Инициализация при загруз.value;
        });

        // Инициализация при загрузке
        document.addEventListenerке
        document.addEventListener('('DOMContentLoaded', initApp);
    </script>
</body>
</htmlDOMContentLoaded', initApp);
    </script>
</body>
</html>
