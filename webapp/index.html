<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftPrises - NFT Подарки</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --text: #ffffff;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-light {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --accent: #ec4899;
            --text: #1f2937;
            --bg: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .theme-dark {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --text: #f3f4f6;
            --bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-switcher {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: var(--text);
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
            transform-origin: center;
        }

        .theme-switcher:hover {
            transform: rotate(180deg) scale(1.1);
            animation: rotate 1s ease-in-out;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 10px;
            display: inline-block;
            animation: bounce 2s infinite, glow 3s infinite alternate;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textShine 3s ease-in-out infinite;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 30px;
            animation: fadeIn 2s ease-out;
        }

        /* Navigation Grid */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        .nav-card:nth-child(1) { animation-delay: 0.1s; }
        .nav-card:nth-child(2) { animation-delay: 0.2s; }
        .nav-card:nth-child(3) { animation-delay: 0.3s; }
        .nav-card:nth-child(4) { animation-delay: 0.4s; }
        .nav-card:nth-child(5) { animation-delay: 0.5s; }

        .nav-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .nav-card:hover::before {
            left: 100%;
        }

        .nav-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .nav-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        .nav-card:nth-child(1) .nav-icon { animation-delay: 0s; }
        .nav-card:nth-child(2) .nav-icon { animation-delay: 0.5s; }
        .nav-card:nth-child(3) .nav-icon { animation-delay: 1s; }
        .nav-card:nth-child(4) .nav-icon { animation-delay: 1.5s; }
        .nav-card:nth-child(5) .nav-icon { animation-delay: 2s; }

        .nav-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .nav-desc {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* Statistics Dashboard */
        .stats-dashboard {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.8s ease-out;
        }

        .stats-dashboard h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent);
            font-size: 1.3rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
            animation: countUp 1s ease-out;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .user-list, .gift-list {
            max-height: 120px;
            overflow-y: auto;
        }

        .user-item, .gift-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 5px;
            transition: var(--transition);
        }

        .user-item:hover, .gift-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .user-name, .gift-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-stats, .gift-stats {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Admin Panel */
        .admin-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h3 {
            margin-bottom: 15px;
            color: var(--accent);
        }

        .toggle-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .toggle-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-btn.disabled {
            background: #ef4444;
            color: white;
        }

        .toggle-btn.enabled {
            background: #10b981;
            color: white;
        }

        /* Sell Gift Screen */
        .sell-form {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1rem;
        }

        .evaluation-result {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--accent);
        }

        .evaluation-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .evaluation-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        .back-button {
            background: var(--card-bg);
            border: none;
            color: var(--text);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            animation: slideInLeft 0.5s ease-out;
        }

        .back-button:hover {
            transform: translateX(-5px);
        }

        /* Models Grid */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .model-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            animation: zoomIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .model-card:hover::before {
            transform: translateX(100%);
        }

        .model-card:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: var(--accent);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .model-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--card-bg), rgba(255,255,255,0.15));
            animation: pulse 2s infinite;
        }

        .gift-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .model-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .model-price {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
            animation: glow 2s infinite alternate;
        }

        /* Search Screen */
        .search-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin: 20px 0;
            animation: slideUp 0.6s ease-out;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 15px;
            transition: var(--transition);
            border: 2px solid transparent;
            animation: slideInRight 0.5s ease-out;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.3);
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
            animation: pulse 2s infinite;
        }

        .theme-light .search-input::placeholder {
            color: rgba(0,0,0,0.6);
        }

        .budget-slider {
            width: 100%;
            margin: 20px 0;
            animation: slideInLeft 0.5s ease-out;
        }

        .budget-value {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 10px 0;
            animation: countUp 1s ease-out;
        }

        /* Results */
        .results-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            animation: slideUp 0.5s ease-out;
        }

        .result-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-model {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .result-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
            animation: glow 2s infinite alternate;
        }

        .result-details {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .action-btn:hover {
            transform: scale(1.05);
            animation: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .action-btn.secondary {
            background: var(--card-bg);
            color: var(--text);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.disabled-btn {
            background: #6b7280 !important;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
        }

        .status-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        /* Features */
        .features {
            margin: 30px 0;
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease-out;
        }

        .feature-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            animation: bounce 2s infinite;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        /* Purchase Flow */
        .purchase-flow {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--card-bg);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .step.active .step-circle {
            background: var(--primary);
            transform: scale(1.1);
        }

        .step-label {
            font-size: 0.8rem;
            text-align: center;
        }

        .payment-info {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .address-box {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .copy-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        /* Gift Image */
        .gift-image-large {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 15px;
            margin: 0 auto 20px;
            display: block;
            border: 3px solid rgba(255,255,255,0.2);
        }

        /* Пакеты подарков */
        .package-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(255,255,255,0.15));
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .package-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .package-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        .package-price {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .package-gifts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .package-gift-item {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 8px;
        }

        .package-gift-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .package-gift-name {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .package-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-10px) scale(1.1); }
            60% { transform: translateY(-5px) scale(1.05); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.6)); }
        }

        @keyframes textShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(90deg) scale(1.1); }
            100% { transform: rotate(180deg) scale(1.1); }
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes countUp {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .nav-grid, .models-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .logo {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Главный экран -->
    <div class="container">
        <div class="screen active" id="main-screen">
            <div class="header">
                <button class="theme-switcher" onclick="switchTheme()">
                    <i class="fas fa-palette"></i>
                </button>
                
                <div class="logo">🎁</div>
                <h1 class="title">GiftPrises</h1>
                <p class="subtitle">Твой мир уникальных NFT подарков</p>
            </div>

            <div class="nav-grid">
                <div class="nav-card" onclick="loadRealGifts()" id="catalog-btn">
                    <div class="nav-icon">📚</div>
                    <div class="nav-title">Каталог NFT</div>
                    <div class="nav-desc">Реальные подарки с маркетплейсов</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('search-screen')" id="search-btn">
                    <div class="nav-icon">🔍</div>
                    <div class="nav-title">Умный поиск</div>
                    <div class="nav-desc">Найди идеальные подарки</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('budget-screen')" id="budget-btn">
                    <div class="nav-icon">💰</div>
                    <div class="nav-title">Бюджет</div>
                    <div class="nav-desc">Установи лимит</div>
                </div>
                
                <div class="nav-card" onclick="showScreen('sell-screen')" id="sell-btn">
                    <div class="nav-icon">💎</div>
                    <div class="nav-title">Продать подарок</div>
                    <div class="nav-desc">Оцени и продай свой NFT</div>
                </div>

                <!-- Админ панель (временно доступна всем) -->
                <div class="nav-card" onclick="showScreen('admin-screen')" id="admin-btn">
                    <div class="nav-icon">⚙️</div>
                    <div class="nav-title">Админ панель</div>
                    <div class="nav-desc">Управление ботом</div>
                </div>
            </div>

            <!-- Статистика на главной странице -->
            <div class="stats-dashboard">
                <h3>📊 Статистика в реальном времени</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Всего пользователей</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="today-online">0</div>
                        <div class="stat-label">Сегодня онлайн</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="daily-turnover">0 TON</div>
                        <div class="stat-label">Оборот за день</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="gifts-sold">0</div>
                        <div class="stat-label">Подарков куплено</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: var(--accent);">🏆 Топ покупателей</h4>
                        <div class="user-list" id="top-buyers">
                            <!-- Топ покупателей будет загружен -->
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: var(--accent);">🔥 Популярные подарки</h4>
                        <div class="gift-list" id="popular-gifts">
                            <!-- Популярные подарки будут загружены -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="features">
                <div class="feature">
                    <span class="feature-icon">⚡</span>
                    Умный подбор NFT подарков по бюджету
                </div>
                <div class="feature">
                    <span class="feature-icon">🎨</span>
                    Реальные NFT с маркетплейсов по лучшим ценам
                </div>
                <div class="feature">
                    <span class="feature-icon">💫</span>
                    Пакеты подарков для максимальной выгоды
                </div>
                <div class="feature">
                    <span class="feature-icon">🛡️</span>
                    Безопасные сделки через TON блокчейн
                </div>
            </div>

            <div class="footer">
                Powered by Telegram WebApp • GiftPrises 2024
            </div>
        </div>

        <!-- Админ панель -->
        <div class="screen" id="admin-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">⚙️ Админ панель</h2>
            
            <div class="admin-panel">
                <div class="admin-section">
                    <h3>📊 Статистика</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="admin-total-users">0</div>
                            <div class="stat-label">Всего пользователей</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="admin-total-sales">0</div>
                            <div class="stat-label">Всего продаж</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="admin-total-revenue">0 TON</div>
                            <div class="stat-label">Общий доход</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="admin-active-users">0</div>
                            <div class="stat-label">Активных сегодня</div>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>🏆 Топ покупателей</h3>
                    <div class="user-list" id="admin-top-users">
                        <!-- Список топ пользователей -->
                    </div>
                </div>

                <div class="admin-section">
                    <h3>🔧 Управление кнопками</h3>
                    <div class="toggle-buttons">
                        <button class="toggle-btn enabled" id="toggle-search" onclick="toggleButton('search')">
                            Поиск подарков ✅
                        </button>
                        <button class="toggle-btn enabled" id="toggle-budget" onclick="toggleButton('budget')">
                            Поиск по бюджету ✅
                        </button>
                        <button class="toggle-btn enabled" id="toggle-sell" onclick="toggleButton('sell')">
                            Продажа подарков ✅
                        </button>
                        <button class="toggle-btn enabled" id="toggle-catalog" onclick="toggleButton('catalog')">
                            Каталог ✅
                        </button>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>📈 Финансы</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="admin-today-revenue">0 TON</div>
                            <div class="stat-label">Доход за сегодня</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="admin-week-revenue">0 TON</div>
                            <div class="stat-label">Доход за неделю</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран продажи подарков -->
        <div class="screen" id="sell-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">💎 Продать NFT подарок</h2>
            
            <div class="sell-form">
                <div class="form-group">
                    <label class="form-label">🔗 Подключите ваш Telegram аккаунт</label>
                    <button class="action-btn" onclick="connectTelegramAccount()" style="width: 100%;">
                        📱 Подключить аккаунт
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">🎁 Выберите подарок для оценки</label>
                    <select class="form-select" id="gift-select">
                        <option value="">-- Выберите подарок --</option>
                        <!-- Список подарков будет загружен -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">🎨 Модель подарка</label>
                    <input type="text" class="search-input" placeholder="Название модели" id="gift-model">
                </div>

                <div class="form-group">
                    <label class="form-label">🌄 Фон</label>
                    <select class="form-select" id="gift-backdrop">
                        <option value="">Любой фон</option>
                        <option value="Звездный">Звездный</option>
                        <option value="Городской">Городской</option>
                        <option value="Природный">Природный</option>
                        <option value="Абстрактный">Абстрактный</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">✨ Узор</label>
                    <select class="form-select" id="gift-symbol">
                        <option value="">Любой узор</option>
                        <option value="Звезды">Звезды</option>
                        <option value="Цветы">Цветы</option>
                        <option value="Геометрия">Геометрия</option>
                        <option value="Полосы">Полосы</option>
                    </select>
                </div>

                <button class="action-btn" onclick="evaluateGift()" style="width: 100%;">
                    💰 Оценить подарок
                </button>

                <div id="evaluation-result" style="display: none;">
                    <!-- Результат оценки -->
                </div>
            </div>
        </div>

        <!-- Экран каталога -->
        <div class="screen" id="catalog-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">📚 Каталог NFT Подарков</h2>
            
            <div class="models-grid" id="catalog-grid">
                <!-- Каталог моделей будет загружен -->
            </div>
        </div>

        <!-- Экран поиска -->
        <div class="screen" id="search-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">🔍 Умный поиск NFT подарков</h2>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🎭 Введите название модели..." id="search-input">
                
                <div class="budget-value">💰 Бюджет: <span id="budget-amount">500</span> TON</div>
                <input type="range" class="budget-slider" min="1" max="100000" value="500" id="budget-slider">
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0;">
                    <button class="action-btn secondary" onclick="setBudget(100)">100 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(500)">500 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(1000)">1K TON</button>
                    <button class="action-btn secondary" onclick="setBudget(5000)">5K TON</button>
                </div>
                
                <button class="action-btn" onclick="performSmartSearch()" style="width: 100%;">
                    🧠 Найти умные предложения
                </button>

                <button class="action-btn secondary" onclick="clearSearch()" style="width: 100%; margin-top: 10px;">
                    🗑️ Очистить поиск
                </button>
            </div>

            <div class="results-grid" id="search-results">
                <!-- Результаты поиска -->
            </div>
        </div>

        <!-- Экран бюджета -->
        <div class="screen" id="budget-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">💰 Установи бюджет</h2>
            
            <div class="search-container">
                <div class="budget-value" style="font-size: 2rem; color: var(--accent);">
                    <span id="budget-display">500</span> TON
                </div>
                <input type="range" class="budget-slider" min="1" max="100000" value="500" id="budget-setter">
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="setBudget(100)">100 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(500)">500 TON</button>
                    <button class="action-btn secondary" onclick="setBudget(1000)">1K TON</button>
                    <button class="action-btn secondary" onclick="setBudget(5000)">5K TON</button>
                    <button class="action-btn secondary" onclick="setBudget(10000)">10K TON</button>
                    <button class="action-btn secondary" onclick="setBudget(50000)">50K TON</button>
                </div>
                
                <button class="action-btn" onclick="saveBudget()" style="width: 100%; margin-top: 20px;">
                    💾 Сохранить бюджет
                </button>
            </div>
        </div>

        <!-- Экран покупки -->
        <div class="screen" id="purchase-screen">
            <button class="back-button" onclick="showScreen('main-screen')">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            
            <h2 style="text-align: center; margin-bottom: 20px;">💳 Оформление покупки</h2>
            
            <div class="purchase-flow">
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Выбор</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Получатель</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Оплата</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Готово</div>
                    </div>
                </div>

                <div id="purchase-content">
                    <!-- Контент покупки будет обновляться -->
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-text">Загружаем данные...</p>
        </div>
    </div>

    <script>
        // Конфигурация
        const DISABLED_BUTTONS = {
            'search': false,
            'budget': false, 
            'sell': false,
            'catalog': false
        };

        // Глобальные переменные
        let tg = window.Telegram.WebApp;
        let currentTheme = 'default';
        let selectedGift = null;
        let userBudget = 500;
        let currentSort = 'price_asc';
        let currentPurchaseStep = 1;
        let recipientUsername = '';
        let purchaseId = '';
        let realGifts = [];
        let paymentCheckInterval = null;

        // Реальная статистика
        let realStats = {
            totalUsers: 0,
            todayOnline: 0,
            dailyTurnover: 0,
            giftsSold: 0,
            totalSales: 0,
            totalRevenue: 0,
            todayRevenue: 0,
            weekRevenue: 0
        };

        // Топ покупателей
        let topBuyers = [];

        // Популярные подарки
        let popularGifts = [];

        // Система статистики
        class StatisticsManager {
            constructor() {
                this.userId = tg.initDataUnsafe.user?.id || `user_${Date.now()}`;
                this.username = tg.initDataUnsafe.user?.username || 'Аноним';
                this.registerActivity();
            }
            
            registerActivity() {
                const activityData = {
                    action: 'user_activity',
                    user_id: this.userId,
                    username: this.username
                };
                
                tg.sendData(JSON.stringify(activityData));
                
                const userKey = `user_${this.userId}`;
                const userData = {
                    id: this.userId,
                    username: this.username,
                    lastSeen: Date.now()
                };
                localStorage.setItem(userKey, JSON.stringify(userData));
                
                this.updateOnlineStatus();
            }
            
            updateOnlineStatus() {
                const onlineKey = 'online_users';
                let onlineUsers = JSON.parse(localStorage.getItem(onlineKey)) || {};
                
                onlineUsers[this.userId] = Date.now();
                
                const now = Date.now();
                Object.keys(onlineUsers).forEach(userId => {
                    if (now - onlineUsers[userId] > 5 * 60 * 1000) {
                        delete onlineUsers[userId];
                    }
                });
                
                localStorage.setItem(onlineKey, JSON.stringify(onlineUsers));
            }
            
            registerPurchase(gift, amount) {
                const purchaseData = {
                    action: 'purchase',
                    user_id: this.userId,
                    username: this.username,
                    gift_id: gift.id,
                    gift_name: gift.name,
                    amount: amount,
                    timestamp: Date.now()
                };
                
                tg.sendData(JSON.stringify(purchaseData));
                this.savePurchaseLocally(purchaseData);
            }
            
            savePurchaseLocally(purchaseData) {
                const purchasesKey = 'purchases';
                let purchases = JSON.parse(localStorage.getItem(purchasesKey)) || [];
                purchases.push(purchaseData);
                localStorage.setItem(purchasesKey, JSON.stringify(purchases));
                
                this.updatePopularGifts(purchaseData.gift_name);
            }
            
            updatePopularGifts(giftName) {
                const popularKey = 'popular_gifts';
                let popularGifts = JSON.parse(localStorage.getItem(popularKey)) || {};
                
                if (!popularGifts[giftName]) {
                    popularGifts[giftName] = 0;
                }
                popularGifts[giftName]++;
                
                localStorage.setItem(popularKey, JSON.stringify(popularGifts));
            }
            
            getStatistics() {
                const usersKey = 'users';
                const onlineKey = 'online_users';
                const purchasesKey = 'purchases';
                
                let users = JSON.parse(localStorage.getItem(usersKey)) || {};
                let onlineUsers = JSON.parse(localStorage.getItem(onlineKey)) || {};
                let purchases = JSON.parse(localStorage.getItem(purchasesKey)) || [];
                
                const totalUsers = Object.keys(users).length;
                const now = Date.now();
                const todayOnline = Object.values(onlineUsers).filter(timestamp => 
                    now - timestamp < 5 * 60 * 1000
                ).length;
                
                const today = new Date().toDateString();
                const dailyTurnover = purchases
                    .filter(p => new Date(p.timestamp).toDateString() === today)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                const giftsSold = purchases.length;
                
                return {
                    totalUsers: Math.max(totalUsers, Object.keys(onlineUsers).length),
                    todayOnline: todayOnline,
                    dailyTurnover: Math.round(dailyTurnover * 100) / 100,
                    giftsSold: giftsSold,
                    totalRevenue: Math.round(purchases.reduce((sum, p) => sum + p.amount, 0) * 100) / 100
                };
            }
            
            getTopBuyers() {
                const purchasesKey = 'purchases';
                let purchases = JSON.parse(localStorage.getItem(purchasesKey)) || [];
                
                const buyerStats = {};
                
                purchases.forEach(purchase => {
                    if (!buyerStats[purchase.user_id]) {
                        buyerStats[purchase.user_id] = {
                            username: purchase.username,
                            spent: 0,
                            purchases: 0
                        };
                    }
                    
                    buyerStats[purchase.user_id].spent += purchase.amount;
                    buyerStats[purchase.user_id].purchases++;
                });
                
                return Object.values(buyerStats)
                    .sort((a, b) => b.spent - a.spent)
                    .slice(0, 10);
            }
            
            getPopularGifts() {
                const popularKey = 'popular_gifts';
                let popularGifts = JSON.parse(localStorage.getItem(popularKey)) || {};
                
                return Object.entries(popularGifts)
                    .map(([name, sales]) => ({ name, sales }))
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 10);
            }
        }

        // Инициализируем менеджер статистики
        const statsManager = new StatisticsManager();

        // API для работы с подарками
        class GiftPrisesAPI {
            constructor() {
                this.baseURL = window.location.origin;
            }
            
            async request(endpoint, data = {}) {
                try {
                    const response = await fetch(`${this.baseURL}/api/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Request failed:', error);
                    return this.getFallbackResponse(endpoint);
                }
            }
            
            getFallbackResponse(endpoint) {
                const fallbackData = {
                    'search': this.generateFallbackGifts(10),
                    'gifts': this.generateFallbackGifts(20),
                    'stats': {
                        totalUsers: 1234,
                        todayOnline: 89,
                        dailyTurnover: 4567.89,
                        giftsSold: 567
                    }
                };
                
                return { success: true, data: fallbackData[endpoint] || {} };
            }
            
            generateFallbackGifts(count) {
                const giftNames = [
                    "Artisan Brick", "Astral Shard", "B-Day Candle", "Berry Box", "Big Year",
                    "Bonded Ring", "Bow Tie", "Bunny Milffin", "Candy Cane", "Clover Pin"
                ];
                
                return Array.from({length: count}, (_, i) => ({
                    id: `fallback_${i}`,
                    name: giftNames[i % giftNames.length],
                    price: 20 + (i * 5),
                    total_price: 20 + (i * 5) * 1.05,
                    image_url: null,
                    market: ['Portals', 'GetGems', 'TON Diamonds'][i % 3],
                    rarity: ['common', 'rare', 'epic', 'legendary'][i % 4],
                    attributes: {
                        backdrop: ['Звездный', 'Городской', 'Природный'][i % 3],
                        symbol: ['Звезды', 'Цветы', 'Геометрия'][i % 3]
                    }
                }));
            }
            
            async searchGifts(filters) {
                return await this.request('search', filters);
            }
            
            async getAllGifts() {
                return await this.request('gifts');
            }
            
            async getStats() {
                return await this.request('stats');
            }
            
            async purchaseGift(giftId, recipient) {
                return await this.request('purchase', { giftId, recipient });
            }
            
            async checkPayment(purchaseId) {
                return await this.request('check-payment', { purchaseId });
            }
        }

        const api = new GiftPrisesAPI();

        // Умный поиск подарков
        async function performSmartSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const budget = userBudget;
            
            showLoading(true, "🧠 Ищем умные предложения...");
            
            try {
                const response = await api.searchGifts({
                    search_term: searchTerm,
                    max_price: budget,
                    min_price: 1
                });
                
                let gifts = response.success ? response.data : [];
                
                // Если нет реальных данных, используем fallback
                if (gifts.length === 0) {
                    gifts = generateSmartGifts(budget, searchTerm);
                }
                
                // Сортируем и фильтруем подарки
                const sortedGifts = sortGiftsByValue(gifts);
                
                // Генерируем умные предложения
                const smartOffers = generateSmartOffers(sortedGifts, budget);
                
                displaySmartResults(smartOffers);
                
            } catch (error) {
                console.error('Search failed:', error);
                const gifts = generateSmartGifts(budget, searchTerm);
                const sortedGifts = sortGiftsByValue(gifts);
                const smartOffers = generateSmartOffers(sortedGifts, budget);
                displaySmartResults(smartOffers);
            } finally {
                showLoading(false);
            }
        }

        // Генерация умных подарков
        function generateSmartGifts(budget, searchTerm = '') {
            const allGiftNames = [
                "Artisan Brick", "Astral Shard", "B-Day Candle", "Berry Box", "Big Year",
                "Bonded Ring", "Bow Tie", "Bunny Milffin", "Candy Cane", "Clover Pin",
                "Cookie Heart", "Crystal Ball", "Cupid Charm", "Desk Calendar", "Diamond Ring",
                "Durov's Cap", "Easter Egg", "Electric Skull", "Eternal Candle", "Eternal Rose"
            ];
            
            // Фильтруем по поисковому запросу
            const filteredNames = searchTerm ? 
                allGiftNames.filter(name => name.toLowerCase().includes(searchTerm)) : 
                allGiftNames;
            
            return filteredNames.map((name, index) => {
                // Генерируем реалистичные цены в зависимости от бюджета
                let basePrice;
                if (budget <= 100) {
                    basePrice = Math.random() * 80 + 20;
                } else if (budget <= 1000) {
                    basePrice = Math.random() * 400 + 100;
                } else if (budget <= 10000) {
                    basePrice = Math.random() * 4000 + 1000;
                } else {
                    basePrice = Math.random() * 40000 + 10000;
                }
                
                const totalPrice = basePrice * 1.05;
                
                return {
                    id: `gift_${index}`,
                    name: name,
                    price: basePrice,
                    total_price: Math.round(totalPrice * 100) / 100,
                    image_url: `https://api.portals.io/gifts/${index}/image`,
                    market: ['Portals', 'GetGems', 'TON Diamonds'][index % 3],
                    attributes: {
                        model: name,
                        backdrop: ['Звездный', 'Городской', 'Природный', 'Абстрактный'][index % 4],
                        symbol: ['Звезды', 'Цветы', 'Геометрия', 'Полосы'][index % 4]
                    },
                    is_transferable: true,
                    rarity: ['common', 'rare', 'epic', 'legendary'][index % 4],
                    sales_count: Math.floor(Math.random() * 100) + 1,
                    price_trend: Math.random() > 0.5 ? 'up' : 'down',
                    liquidity: Math.random() * 100
                };
            });
        }

        // Сортировка подарков по ценности
        function sortGiftsByValue(gifts) {
            return gifts.sort((a, b) => {
                // Оцениваем ценность подарка (чем выше - тем лучше)
                const valueA = calculateGiftValue(a);
                const valueB = calculateGiftValue(b);
                return valueB - valueA;
            });
        }

        // Расчет ценности подарка
        function calculateGiftValue(gift) {
            let value = 0;
            
            // Редкость
            const rarityMultiplier = {
                'common': 1,
                'rare': 1.5,
                'epic': 2,
                'legendary': 3
            };
            
            value += rarityMultiplier[gift.rarity] * 10;
            
            // Ликвидность
            value += gift.liquidity * 0.5;
            
            // Тренд цены
            if (gift.price_trend === 'up') value += 15;
            
            // Популярность
            value += Math.log(gift.sales_count + 1) * 5;
            
            // Соотношение цена/качество (чем дешевле относительно редкости - тем лучше)
            const priceQuality = rarityMultiplier[gift.rarity] / (gift.total_price / 100);
            value += priceQuality * 20;
            
            return value;
        }

        // Генерация умных предложений
        function generateSmartOffers(gifts, budget) {
            const offers = [];
            
            // 1. Одиночные подарки (лучшие по ценности)
            const singleGifts = gifts
                .filter(g => g.total_price <= budget)
                .slice(0, 3);
            
            singleGifts.forEach(gift => {
                offers.push({
                    type: 'single',
                    title: `🎁 ${gift.name}`,
                    gifts: [gift],
                    total_price: gift.total_price,
                    savings: 0,
                    value_score: calculateGiftValue(gift),
                    description: getGiftDescription(gift)
                });
            });
            
            // 2. Пакеты подарков (для больших бюджетов)
            if (budget >= 1000) {
                const packages = generateGiftPackages(gifts, budget);
                offers.push(...packages);
            }
            
            // 3. Лучшее предложение (самое выгодное)
            if (offers.length > 0) {
                const bestOffer = offers.reduce((best, current) => 
                    (current.value_score / current.total_price) > (best.value_score / best.total_price) ? current : best
                );
                bestOffer.type = 'best';
                bestOffer.title = `🏆 ЛУЧШЕЕ: ${bestOffer.title}`;
            }
            
            return offers.sort((a, b) => (b.value_score / b.total_price) - (a.value_score / a.total_price));
        }

        // Генерация пакетов подарков
        function generateGiftPackages(gifts, budget) {
            const packages = [];
            const availableGifts = gifts.filter(g => g.total_price <= budget * 0.3);
            
            if (availableGifts.length < 3) return packages;
            
            // Пакет "Разнообразие" - разные типы подарков
            const diversityPackage = [];
            let diversityPrice = 0;
            const usedTypes = new Set();
            
            availableGifts.sort(() => Math.random() - 0.5).forEach(gift => {
                if (diversityPackage.length < 5 && diversityPrice + gift.total_price <= budget * 0.8) {
                    if (!usedTypes.has(gift.rarity)) {
                        diversityPackage.push(gift);
                        diversityPrice += gift.total_price;
                        usedTypes.add(gift.rarity);
                    }
                }
            });
            
            if (diversityPackage.length >= 3) {
                packages.push({
                    type: 'package',
                    title: '🎨 Пакет "Разнообразие"',
                    gifts: diversityPackage,
                    total_price: Math.round(diversityPrice * 100) / 100,
                    savings: Math.round((diversityPrice * 0.1) * 100) / 100,
                    value_score: diversityPackage.reduce((sum, g) => sum + calculateGiftValue(g), 0),
                    description: `Набор из ${diversityPackage.length} уникальных подарков разных типов`
                });
            }
            
            // Пакет "Инвестиционный" - подарки с растущей ценой
            const investmentGifts = availableGifts
                .filter(g => g.price_trend === 'up' && g.liquidity > 50)
                .slice(0, 4);
                
            if (investmentGifts.length >= 2) {
                const investmentPrice = investmentGifts.reduce((sum, g) => sum + g.total_price, 0);
                packages.push({
                    type: 'package',
                    title: '📈 Пакет "Инвестиционный"',
                    gifts: investmentGifts,
                    total_price: Math.round(investmentPrice * 100) / 100,
                    savings: Math.round((investmentPrice * 0.15) * 100) / 100,
                    value_score: investmentGifts.reduce((sum, g) => sum + calculateGiftValue(g), 0),
                    description: `Подарки с растущей стоимостью и высокой ликвидностью`
                });
            }
            
            return packages;
        }

        // Описание подарка
        function getGiftDescription(gift) {
            const descriptions = {
                'common': 'Хороший выбор для начала коллекции',
                'rare': 'Популярный подарок с стабильной ценой',
                'epic': 'Эксклюзивный подарок с потенциалом роста',
                'legendary': 'Редкий коллекционный экземпляр'
            };
            
            const trend = gift.price_trend === 'up' ? '📈 Растет в цене' : '📉 Стабильная цена';
            const liquidity = gift.liquidity > 70 ? '🚀 Высокая ликвидность' : '💧 Средняя ликвидность';
            
            return `${descriptions[gift.rarity]}. ${trend}. ${liquidity}`;
        }

        // Отображение умных результатов
        function displaySmartResults(offers) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if (offers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">😔</div>
                        <h3>Ничего не найдено</h3>
                        <p>Попробуйте изменить бюджет или параметры поиска</p>
                    </div>
                `;
                return;
            }
            
            offers.forEach((offer, index) => {
                const card = document.createElement('div');
                card.className = offer.type === 'package' ? 'package-card' : 'result-card';
                
                if (offer.type === 'package') {
                    card.innerHTML = `
                        <div class="package-badge">ПАКЕТ</div>
                        <div class="package-header">
                            <div class="package-title">${offer.title}</div>
                            <div class="package-price">${offer.total_price} TON</div>
                        </div>
                        <div class="result-details">${offer.description}</div>
                        
                        <div class="package-gifts">
                            ${offer.gifts.map(gift => `
                                <div class="package-gift-item">
                                    <img src="${gift.image_url}" alt="${gift.name}" class="package-gift-image"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iNiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjEpIi8+Cjx0ZXh0IHg9IjIwIiB5PSIyMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTIiPj7inaQ8L3RleHQ+Cjwvc3ZnPg=='">
                                    <div class="package-gift-name">${gift.name}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="package-stats">
                            <span>🎯 Ценность: ${Math.round(offer.value_score)}</span>
                            <span>💰 Экономия: ${offer.savings} TON</span>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn secondary" onclick="showPackageDetails(${index})">
                                ℹ️ Подробнее
                            </button>
                            <button class="action-btn" onclick="selectPackage(${index})">
                                🎁 Выбрать пакет
                            </button>
                        </div>
                    `;
                } else {
                    const gift = offer.gifts[0];
                    card.innerHTML = `
                        <div class="result-header">
                            <div class="result-model">${offer.title}</div>
                            <div class="result-price">${offer.total_price} TON</div>
                        </div>
                        <div class="result-details">
                            ${offer.description}<br>
                            🎯 Ценность: ${Math.round(offer.value_score)} | ${gift.market}
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn secondary" onclick="showGiftDetails('${gift.id}')">
                                ℹ️ Подробнее
                            </button>
                            <button class="action-btn" onclick="selectGift(${JSON.stringify(gift).replace(/"/g, '&quot;')})">
                                🎁 Выбрать
                            </button>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Показать детали пакета
        function showPackageDetails(packageIndex) {
            // В реальном приложении можно показать модальное окно с деталями
            showStatusMessage('Детальная информация о пакете подарков', 'info');
        }

        // Выбор пакета
        function selectPackage(packageIndex) {
            showStatusMessage('Функция выбора пакета в разработке', 'info');
        }

        // Инициализация приложения
        function initApp() {
            tg.expand();
            tg.enableClosingConfirmation();
            
            document.body.classList.add('theme-transition');
            
            loadButtonStatus();
            loadRealGiftsData();
            loadGiftsForSale();
            loadRealStats();
            
            setInterval(loadRealStats, 10000);
            setInterval(() => statsManager.updateOnlineStatus(), 60000);
        }

        // Остальные функции остаются без изменений
        function loadRealStats() {
            const stats = statsManager.getStatistics();
            const topBuyers = statsManager.getTopBuyers();
            const popularGifts = statsManager.getPopularGifts();
            
            realStats = { ...realStats, ...stats };
            window.topBuyers = topBuyers;
            window.popularGifts = popularGifts;
            
            updateStatsDisplay();
            updateTopBuyersDisplay();
            updatePopularGiftsDisplay();
        }

        function updateStatsDisplay() {
            animateValue(document.getElementById('total-users'), parseInt(document.getElementById('total-users').textContent) || 0, realStats.totalUsers, 1000);
            animateValue(document.getElementById('today-online'), parseInt(document.getElementById('today-online').textContent) || 0, realStats.todayOnline, 1000);
            animateValue(document.getElementById('gifts-sold'), parseInt(document.getElementById('gifts-sold').textContent) || 0, realStats.giftsSold, 1000);
            
            const turnoverElement = document.getElementById('daily-turnover');
            turnoverElement.textContent = realStats.dailyTurnover + ' TON';
            
            animateValue(document.getElementById('admin-total-users'), parseInt(document.getElementById('admin-total-users').textContent) || 0, realStats.totalUsers, 1000);
            animateValue(document.getElementById('admin-total-sales'), parseInt(document.getElementById('admin-total-sales').textContent) || 0, realStats.totalSales, 1000);
            animateValue(document.getElementById('admin-active-users'), parseInt(document.getElementById('admin-active-users').textContent) || 0, realStats.todayOnline, 1000);
            
            document.getElementById('admin-total-revenue').textContent = realStats.totalRevenue + ' TON';
            document.getElementById('admin-today-revenue').textContent = realStats.todayRevenue + ' TON';
            document.getElementById('admin-week-revenue').textContent = realStats.weekRevenue + ' TON';
        }

        function updateTopBuyersDisplay() {
            const topBuyersContainer = document.getElementById('top-buyers');
            const adminTopUsersContainer = document.getElementById('admin-top-users');
            
            const sortedBuyers = [...topBuyers].sort((a, b) => b.spent - a.spent);
            
            const buyersHTML = sortedBuyers.map(buyer => `
                <div class="user-item">
                    <div class="user-name">${buyer.username}</div>
                    <div class="user-stats">${buyer.spent} TON</div>
                </div>
            `).join('');
            
            topBuyersContainer.innerHTML = buyersHTML;
            adminTopUsersContainer.innerHTML = buyersHTML;
        }

        function updatePopularGiftsDisplay() {
            const popularGiftsContainer = document.getElementById('popular-gifts');
            
            if (popularGifts.length === 0) {
                popularGiftsContainer.innerHTML = `
                    <div style="text-align: center; padding: 10px; opacity: 0.7;">
                        Пока нет продаж
                    </div>
                `;
                return;
            }
            
            const giftsHTML = popularGifts.map(gift => `
                <div class="gift-item">
                    <div class="gift-name">${gift.name}</div>
                    <div class="gift-stats">${gift.sales} продаж</div>
                </div>
            `).join('');
            
            popularGiftsContainer.innerHTML = giftsHTML;
        }

        function animateValue(element, start, end, duration) {
            if (start === end) return;
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.textContent = value.toLocaleString();
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function registerPurchase(gift, buyerUsername, amount) {
            statsManager.registerPurchase(gift, amount);
            
            realStats.giftsSold++;
            realStats.totalSales++;
            realStats.dailyTurnover += amount;
            realStats.totalRevenue += amount;
            realStats.todayRevenue += amount;
            realStats.weekRevenue += amount;
            
            updateStatsDisplay();
            updateTopBuyersDisplay();
            updatePopularGiftsDisplay();
        }

        // Инициализация приложения
        function initApp() {
            tg.expand();
            tg.enableClosingConfirmation();
            
            // Загружаем статус кнопок
            loadButtonStatus();
            
            // Загружаем реальные данные о подарках
            loadRealGiftsData();
            
            // Загружаем данные для продажи подарков
            loadGiftsForSale();
            
            // Загружаем реальную статистику
            loadRealStats();
            
            // Обновляем статистику каждые 10 секунд
            setInterval(loadRealStats, 10000);
        }

        // Загрузка реальной статистики
        async function loadRealStats() {
            try {
                // В реальном приложении здесь будет запрос к вашему API
                // Для демонстрации имитируем получение данных
                
                // Получаем данные из localStorage (в реальном приложении - с сервера)
                const savedStats = JSON.parse(localStorage.getItem('giftPrises_stats')) || realStats;
                const savedBuyers = JSON.parse(localStorage.getItem('giftPrises_topBuyers')) || topBuyers;
                const savedPopular = JSON.parse(localStorage.getItem('giftPrises_popularGifts')) || [];
                
                // Обновляем статистику
                realStats = { ...realStats, ...savedStats };
                topBuyers = savedBuyers;
                popularGifts = savedPopular;
                
                // Обновляем отображение
                updateStatsDisplay();
                updateTopBuyersDisplay();
                updatePopularGiftsDisplay();
                
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Обновление отображения статистики
        function updateStatsDisplay() {
            // Главная страница
            animateValue(document.getElementById('total-users'), parseInt(document.getElementById('total-users').textContent) || 0, realStats.totalUsers, 1000);
            animateValue(document.getElementById('today-online'), parseInt(document.getElementById('today-online').textContent) || 0, realStats.todayOnline, 1000);
            animateValue(document.getElementById('gifts-sold'), parseInt(document.getElementById('gifts-sold').textContent) || 0, realStats.giftsSold, 1000);
            
            // Обновляем оборот
            const turnoverElement = document.getElementById('daily-turnover');
            turnoverElement.textContent = realStats.dailyTurnover + ' TON';
            
            // Админ панель
            animateValue(document.getElementById('admin-total-users'), parseInt(document.getElementById('admin-total-users').textContent) || 0, realStats.totalUsers, 1000);
            animateValue(document.getElementById('admin-total-sales'), parseInt(document.getElementById('admin-total-sales').textContent) || 0, realStats.totalSales, 1000);
            animateValue(document.getElementById('admin-active-users'), parseInt(document.getElementById('admin-active-users').textContent) || 0, realStats.todayOnline, 1000);
            
            document.getElementById('admin-total-revenue').textContent = realStats.totalRevenue + ' TON';
            document.getElementById('admin-today-revenue').textContent = realStats.todayRevenue + ' TON';
            document.getElementById('admin-week-revenue').textContent = realStats.weekRevenue + ' TON';
        }

        // Обновление топа покупателей
        function updateTopBuyersDisplay() {
            const topBuyersContainer = document.getElementById('top-buyers');
            const adminTopUsersContainer = document.getElementById('admin-top-users');
            
            // Сортируем по потраченной сумме (по убыванию)
            const sortedBuyers = [...topBuyers].sort((a, b) => b.spent - a.spent);
            
            const buyersHTML = sortedBuyers.map(buyer => `
                <div class="user-item">
                    <div class="user-name">${buyer.username}</div>
                    <div class="user-stats">${buyer.spent} TON</div>
                </div>
            `).join('');
            
            topBuyersContainer.innerHTML = buyersHTML;
            adminTopUsersContainer.innerHTML = buyersHTML;
        }

        // Обновление популярных подарков
        function updatePopularGiftsDisplay() {
            const popularGiftsContainer = document.getElementById('popular-gifts');
            
            if (popularGifts.length === 0) {
                popularGiftsContainer.innerHTML = `
                    <div style="text-align: center; padding: 10px; opacity: 0.7;">
                        Пока нет продаж
                    </div>
                `;
                return;
            }
            
            const giftsHTML = popularGifts.map(gift => `
                <div class="gift-item">
                    <div class="gift-name">${gift.name}</div>
                    <div class="gift-stats">${gift.sales} продаж</div>
                </div>
            `).join('');
            
            popularGiftsContainer.innerHTML = giftsHTML;
        }

        // Функция анимации чисел
        function animateValue(element, start, end, duration) {
            if (start === end) return;
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.textContent = value.toLocaleString();
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Симуляция активности пользователей (для демонстрации)
        function simulateUserActivity() {
            // Увеличиваем количество онлайн пользователей
            realStats.todayOnline = Math.floor(Math.random() * 50) + 10;
            
            // Сохраняем в localStorage
            localStorage.setItem('giftPrises_stats', JSON.stringify(realStats));
            
            // Обновляем отображение
            updateStatsDisplay();
        }

        // Функция для регистрации покупки (вызывается при успешной покупке)
        function registerPurchase(gift, buyerUsername, amount) {
            // Обновляем статистику
            realStats.giftsSold++;
            realStats.totalSales++;
            realStats.dailyTurnover += amount;
            realStats.totalRevenue += amount;
            realStats.todayRevenue += amount;
            realStats.weekRevenue += amount;
            
            // Обновляем топ покупателей
            const buyerIndex = topBuyers.findIndex(b => b.username === buyerUsername);
            if (buyerIndex !== -1) {
                topBuyers[buyerIndex].spent += amount;
                topBuyers[buyerIndex].purchases++;
            } else {
                // Добавляем нового покупателя
                topBuyers.push({
                    username: buyerUsername,
                    spent: amount,
                    purchases: 1
                });
            }
            
            // Обновляем популярные подарки
            const giftIndex = popularGifts.findIndex(g => g.name === gift.name);
            if (giftIndex !== -1) {
                popularGifts[giftIndex].sales++;
            } else {
                popularGifts.push({
                    name: gift.name,
                    sales: 1
                });
            }
            
            // Сохраняем в localStorage
            localStorage.setItem('giftPrises_stats', JSON.stringify(realStats));
            localStorage.setItem('giftPrises_topBuyers', JSON.stringify(topBuyers));
            localStorage.setItem('giftPrises_popularGifts', JSON.stringify(popularGifts));
            
            // Обновляем отображение
            updateStatsDisplay();
            updateTopBuyersDisplay();
            updatePopularGiftsDisplay();
        }

        // Загрузка данных для админ панели
        function loadAdminData() {
            // Данные уже загружаются в loadRealStats()
        }

        // Загрузка статуса кнопок
        function loadButtonStatus() {
            Object.keys(DISABLED_BUTTONS).forEach(buttonId => {
                updateButtonAppearance(buttonId, DISABLED_BUTTONS[buttonId]);
            });
        }

        // Переключение кнопок
        function toggleButton(buttonType) {
            DISABLED_BUTTONS[buttonType] = !DISABLED_BUTTONS[buttonType];
            updateButtonAppearance(buttonType, DISABLED_BUTTONS[buttonType]);
            
            // Сохраняем статус
            tg.sendData(JSON.stringify({
                action: 'toggle_button',
                button_type: buttonType,
                disabled: DISABLED_BUTTONS[buttonType]
            }));
            
            showStatusMessage(`Кнопка "${getButtonName(buttonType)}" ${DISABLED_BUTTONS[buttonType] ? 'отключена' : 'включена'}`, 'success');
        }

        // Обновление внешнего вида кнопки
        function updateButtonAppearance(buttonType, disabled) {
            const button = document.getElementById(`toggle-${buttonType}`);
            const navButton = document.getElementById(`${buttonType}-btn`);
            
            if (button) {
                button.className = `toggle-btn ${disabled ? 'disabled' : 'enabled'}`;
                button.textContent = `${getButtonName(buttonType)} ${disabled ? '❌' : '✅'}`;
            }
            
            if (navButton) {
                if (disabled) {
                    navButton.classList.add('disabled-btn');
                    navButton.onclick = () => showDisabledMessage(buttonType);
                } else {
                    navButton.classList.remove('disabled-btn');
                    // Восстанавливаем оригинальный обработчик
                    switch(buttonType) {
                        case 'search':
                            navButton.onclick = () => showScreen('search-screen');
                            break;
                        case 'budget':
                            navButton.onclick = () => showScreen('budget-screen');
                            break;
                        case 'sell':
                            navButton.onclick = () => showScreen('sell-screen');
                            break;
                        case 'catalog':
                            navButton.onclick = () => loadRealGifts();
                            break;
                    }
                }
            }
        }

        // Показать сообщение об отключенной кнопке
        function showDisabledMessage(buttonType) {
            const message = `🚧 Кнопка "${getButtonName(buttonType)}" временно отключена на техническом обслуживании. Мы уведомим вас, когда функционал будет доступен снова.`;
            tg.showPopup({
                title: 'Технические работы',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }

        // Получение читаемого имени кнопки
        function getButtonName(buttonType) {
            const names = {
                'search': 'Поиск подарков',
                'budget': 'Поиск по бюджету', 
                'sell': 'Продажа подарков',
                'catalog': 'Каталог'
            };
            return names[buttonType] || buttonType;
        }

        // Подключение Telegram аккаунта
        function connectTelegramAccount() {
            showLoading(true, "Подключаем ваш аккаунт...");
            
            setTimeout(() => {
                showLoading(false);
                showStatusMessage('✅ Аккаунт успешно подключен! Теперь вы можете оценить свои подарки.', 'success');
                
                // Имитация загрузки подарков пользователя
                loadUserGifts();
            }, 2000);
        }

        // Загрузка подарков пользователя
        function loadUserGifts() {
            const userGifts = [
                'Artisan Brick',
                'Crystal Ball', 
                'Eternal Rose',
                'Diamond Ring',
                'Magic Potion',
                'Astral Shard',
                'Bunny Milffin',
                'Genie Lamp',
                'Heroic Helmet',
                'Plush Pepe'
            ];
            
            const select = document.getElementById('gift-select');
            select.innerHTML = '<option value="">-- Выберите подарок --</option>' +
                userGifts.map(gift => `<option value="${gift}">${gift}</option>`).join('');
        }

        // Загрузка подарков для продажи
        function loadGiftsForSale() {
            loadUserGifts(); // Используем тот же список
        }

        // Загрузка реальных данных о подарках
        function loadRealGiftsData() {
            const giftNames = [
                "Artisan Brick", "Astral Shard", "B-Day Candle", "Berry Box", "Big Year",
                "Bonded Ring", "Bow Tie", "Bunny Milffin", "Candy Cane", "Clover Pin",
                "Cookie Heart", "Crystal Ball", "Cupid Charm", "Desk Calendar", "Diamond Ring",
                "Durov's Cap", "Easter Egg", "Electric Skull", "Eternal Candle", "Eternal Rose",
                "Evil Eye", "Flying Broom", "Fresh Socks", "Gem Signet", "Genie Lamp",
                "Ginger Cookie", "Hanging Star", "Heart Locket", "Heroic Helmet", "Hex Pot",
                "Holiday Drink", "Homemade Cake", "Hypno Lollipop", "Input Key", "Ion Gem",
                "Ionic Dryer", "Jack-in-the-Box", "Jelly Bunny", "Jester Hat", "Jingle Bells",
                "Jolly Chimp", "Joyful Bundle", "Kissed Frog", "Light Sword", "Lol Pop",
                "Loot Bag", "Love Candle", "Love Potion", "Low Rider", "Lunar Snake",
                "Lush Bouquet", "Mad Pumpkin", "Magic Potion", "Mighty Arm", "Mini Oscar",
                "Moon Pandante", "Nail Bracelet", "Neko Helmet", "Party Sparkler", "Perfume Bottle",
                "Pet Snake", "Plush Pepe", "Precious Peach", "Record Player", "Restless Jar",
                "Sakura Flower", "Santa Hat", "Scared Cat", "Sharp Tongue", "Signet Ring",
                "Skull Flower", "Sky Stilettos", "Sleigh Bell", "Snake Box", "Snoop Cigar",
                "Snoop Dogg", "Snow Globe", "Snow Mittens", "Spiced Wine", "Spy Agaric",
                "Star Notepad", "Stellar Rocket", "Swag Bag", "Swiss Watch", "Tama Gadget",
                "Top Hat", "Toy Bear", "Trapped Heart", "Valentine Box", "Vintage Cigar",
                "Voodoo Doll", "Westside Sign", "Whip Cupcake", "Winter Weath", "Witch Hat",
                "Xmas Strocking"
            ];
            
            realGifts = giftNames.map((name, index) => {
                const basePrice = Math.floor(Math.random() * 80) + 20;
                const totalPrice = basePrice * 1.05;
                
                return {
                    id: `gift_${index + 1}`,
                    name: name,
                    base_price: basePrice,
                    total_price: Math.round(totalPrice * 100) / 100,
                    image_url: `https://api.portals.io/gifts/${index + 1}/image`,
                    market: ['Portals', 'GetGems', 'TON Diamonds'][Math.floor(Math.random() * 3)],
                    attributes: {
                        model: name,
                        backdrop: ['Любой фон', 'Звездный', 'Городской', 'Природный', 'Абстрактный'][Math.floor(Math.random() * 5)],
                        symbol: ['Любой узор', 'Звезды', 'Цветы', 'Геометрия', 'Полосы'][Math.floor(Math.random() * 5)]
                    },
                    is_transferable: true,
                    rarity: ['common', 'rare', 'epic', 'legendary'][Math.floor(Math.random() * 4)],
                    sales_count: Math.floor(Math.random() * 100) + 1
                };
            });
        }

        // Загрузка реальных подарков
        function loadRealGifts() {
            if (DISABLED_BUTTONS['catalog']) {
                showDisabledMessage('catalog');
                return;
            }
            showScreen('catalog-screen');
            displayRealGifts(realGifts);
        }

        // Отображение реальных подарков
        function displayRealGifts(gifts) {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '';
            
            gifts.forEach(gift => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.onclick = () => selectGift(gift);
                
                card.innerHTML = `
                    <img src="${gift.image_url}" alt="${gift.name}" class="gift-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iMTAiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPgo8dGV4dCB4PSI0MCIgeT0iNDUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjEyIj4kTkZUPzwvdGV4dD4KPC9zdmc+'">
                    <div class="model-name">${gift.name}</div>
                    <div class="model-price">${gift.total_price} TON</div>
                    <div style="font-size: 0.7rem; opacity: 0.6; margin-top: 5px;">
                        ${getRarityText(gift.rarity)} • ${gift.market}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Оценка подарка
        function evaluateGift() {
            const giftModel = document.getElementById('gift-model').value;
            const giftBackdrop = document.getElementById('gift-backdrop').value;
            const giftSymbol = document.getElementById('gift-symbol').value;
            const selectedGift = document.getElementById('gift-select').value;
            
            if (!giftModel && !selectedGift) {
                showStatusMessage('❌ Пожалуйста, выберите или введите название подарка', 'error');
                return;
            }
            
            const giftName = selectedGift || giftModel;
            
            showLoading(true, "🔍 Оцениваем подарок на маркетплейсах...");
            
            setTimeout(() => {
                showLoading(false);
                
                const marketPrice = Math.floor(Math.random() * 100) + 20;
                const ourCommission = marketPrice * 0.05;
                const marketCommission = marketPrice * 0.1;
                const finalPrice = marketPrice - ourCommission - marketCommission;
                
                const resultDiv = document.getElementById('evaluation-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="evaluation-result">
                        <div class="evaluation-price">${finalPrice.toFixed(2)} TON</div>
                        <div class="evaluation-details">
                            <strong>${giftName}</strong><br>
                            💰 Рыночная цена: ${marketPrice.toFixed(2)} TON<br>
                            🏪 Комиссия маркетплейса: ${marketCommission.toFixed(2)} TON (10%)<br>
                            💼 Наша комиссия: ${ourCommission.toFixed(2)} TON (5%)<br>
                            🌄 Фон: ${giftBackdrop || 'Любой'}<br>
                            ✨ Узор: ${giftSymbol || 'Любой'}<br><br>
                            <button class="action-btn" onclick="confirmSale()" style="width: 100%;">
                                ✅ Подтвердить продажу
                            </button>
                        </div>
                    </div>
                `;
            }, 3000);
        }

        // Подтверждение продажи
        function confirmSale() {
            tg.showPopup({
                title: '✅ Продажа подтверждена',
                message: 'Ваш подарок будет продан по оцененной цене. Средства поступят на ваш счет в течение 24 часов.',
                buttons: [{ type: 'ok' }]
            });
        }

        // Выбор подарка
        function selectGift(gift) {
            selectedGift = gift;
            showScreen('purchase-screen');
            updatePurchaseStep(1);
        }

        // Обновление шага покупки
        function updatePurchaseStep(step) {
            currentPurchaseStep = step;
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                if (index + 1 <= step) {
                    stepEl.classList.add('active');
                } else {
                    stepEl.classList.remove('active');
                }
            });
            
            const content = document.getElementById('purchase-content');
            switch(step) {
                case 1:
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">🎁 Вы выбрали:</h3>
                        <img src="${selectedGift.image_url}" alt="${selectedGift.name}" class="gift-image-large"
                             onerror="this.style.display='none'">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 5px;">${selectedGift.name}</div>
                            <div style="font-size: 1.2rem; color: var(--accent);">${selectedGift.total_price} TON</div>
                            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">
                                ${selectedGift.market} • ${getRarityText(selectedGift.rarity)}
                            </div>
                        </div>
                        <button class="action-btn" onclick="updatePurchaseStep(2)" style="width: 100%;">
                            Далее ➡️
                        </button>
                    `;
                    break;
                    
                case 2:
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">👤 Кому отправить подарок?</h3>
                        <input type="text" class="search-input" placeholder="@username или оставьте пустым для себя" id="recipient-input">
                        <div class="status-message status-info" style="display: none;" id="username-status">
                            Проверяем username...
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="action-btn secondary" onclick="updatePurchaseStep(1)">
                                ⬅️ Назад
                            </button>
                            <button class="action-btn" onclick="validateAndSetRecipient()" id="recipient-btn">
                                Проверить и продолжить ➡️
                            </button>
                        </div>
                    `;
                    break;
                    
                case 3:
                    purchaseId = 'purchase_' + Date.now();
                    const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
                    
                    content.innerHTML = `
                        <h3 style="text-align: center; margin-bottom: 20px;">💳 Оплата</h3>
                        <div class="payment-info">
                            <div style="margin-bottom: 15px;">
                                <strong>Подарок:</strong> ${selectedGift.name}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Получатель:</strong> ${recipientUsername || 'Себе'}
                            </div>
                            <div style="font-size: 1.3rem; font-weight: 600; color: var(--accent); margin-bottom: 20px;">
                                Сумма: ${selectedGift.total_price} TON
                            </div>
                            
                            <div class="address-box">
                                <strong>Адрес кошелька:</strong><br>
                                EQABC123DEF456GHI789JKL012MNO345PQR678STU
                            </div>
                            
                            <div class="address-box">
                                <strong>Memo (обязательно):</strong><br>
                                ${memo}
                            </div>
                            
                            <button class="copy-btn" onclick="copyPaymentDetails()" style="margin-right: 10px;">
                                📋 Скопировать данные
                            </button>
                            
                            <button class="copy-btn" onclick="sharePaymentDetails()">
                                📤 Поделиться
                            </button>
                        </div>
                        
                        <div class="status-message status-info" id="payment-status">
                            ⏳ Ожидаем подтверждения оплаты...
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="action-btn secondary" onclick="updatePurchaseStep(2)">
                                ⬅️ Назад
                            </button>
                            <button class="action-btn" onclick="checkPaymentStatus()" id="check-payment-btn">
                                🔄 Проверить оплату
                            </button>
                        </div>
                    `;
                    
                    startPaymentChecking();
                    break;
                    
                case 4:
                    // Регистрируем покупку
                    const buyerUsername = recipientUsername || '@current_user';
                    registerPurchase(selectedGift, buyerUsername, selectedGift.total_price);
                    
                    content.innerHTML = `
                        <div style="text-align: center; padding: 30px 0;">
                            <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
                            <h3 style="margin-bottom: 15px;">Подарок отправлен!</h3>
                            <p style="margin-bottom: 25px; opacity: 0.8;">
                                <strong>${selectedGift.name}</strong> был успешно отправлен ${recipientUsername ? 'пользователю ' + recipientUsername : 'вам'}!
                            </p>
                            <div class="status-message status-success">
                                ✅ Транзакция подтверждена. Подарок доставлен.
                            </div>
                            <button class="action-btn" onclick="showScreen('main-screen')" style="width: 100%; margin-top: 20px;">
                                🏠 На главную
                            </button>
                        </div>
                    `;
                    
                    stopPaymentChecking();
                    break;
            }
        }

        // Валидация и установка получателя
        async function validateAndSetRecipient() {
            const input = document.getElementById('recipient-input');
            const username = input.value.trim();
            const statusDiv = document.getElementById('username-status');
            const button = document.getElementById('recipient-btn');
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-message status-info';
            statusDiv.innerHTML = '🔍 Проверяем username...';
            button.disabled = true;
            
            const isValid = await validateUsername(username);
            
            if (isValid) {
                recipientUsername = username;
                statusDiv.className = 'status-message status-success';
                statusDiv.innerHTML = '✅ Username корректен';
                setTimeout(() => {
                    updatePurchaseStep(3);
                }, 1000);
            } else {
                statusDiv.className = 'status-message status-error';
                statusDiv.innerHTML = '❌ Username не найден или некорректен';
                button.disabled = false;
            }
        }

        // Валидация username
        async function validateUsername(username) {
            if (!username) {
                return true;
            }
            
            if (!username.startsWith('@')) {
                return false;
            }
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(username.length >= 5);
                }, 1500);
            });
        }

        // Копирование данных для оплаты
        function copyPaymentDetails() {
            const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
            const text = `Адрес: EQABC123DEF456GHI789JKL012MNO345PQR678STU\nСумма: ${selectedGift.total_price} TON\nMemo: ${memo}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showStatusMessage('Данные для оплаты скопированы в буфер обмена!', 'success');
            });
        }

        // Поделиться данными для оплаты
        function sharePaymentDetails() {
            const memo = recipientUsername ? `gift:${selectedGift.id},for:${recipientUsername}` : `gift:${selectedGift.id}`;
            const text = `Отправьте ${selectedGift.total_price} TON на адрес: EQABC123DEF456GHI789JKL012MNO345PQR678STU с memo: ${memo}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Оплата NFT подарка',
                    text: text
                });
            } else {
                copyPaymentDetails();
            }
        }

        // Запуск проверки оплаты
        function startPaymentChecking() {
            paymentCheckInterval = setInterval(checkPaymentStatus, 10000);
        }

        // Остановка проверки оплаты
        function stopPaymentChecking() {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
        }

        // Проверка статуса оплаты
        async function checkPaymentStatus() {
            const statusDiv = document.getElementById('payment-status');
            const button = document.getElementById('check-payment-btn');
            
            statusDiv.className = 'status-message status-info';
            statusDiv.innerHTML = '🔍 Проверяем статус оплаты...';
            button.disabled = true;
            
            const isPaid = await simulatePaymentCheck();
            
            if (isPaid) {
                statusDiv.className = 'status-message status-success';
                statusDiv.innerHTML = '✅ Оплата подтверждена! Отправляем подарок...';
                
                setTimeout(() => {
                    updatePurchaseStep(4);
                }, 2000);
            } else {
                statusDiv.className = 'status-message status-warning';
                statusDiv.innerHTML = '⏳ Оплата еще не поступила. Проверьте транзакцию.';
                button.disabled = false;
            }
        }

        // Имитация проверки оплаты
        async function simulatePaymentCheck() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(Math.random() < 0.3);
                }, 2000);
            });
        }

        // Поиск NFT
        function performSearch() {
            if (DISABLED_BUTTONS['search']) {
                showDisabledMessage('search');
                return;
            }

            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const budget = userBudget;
            
            showLoading(true, "🔍 Ищем подарки...");
            
            setTimeout(() => {
                const results = realGifts.filter(gift => {
                    const matchesSearch = !searchTerm || gift.name.toLowerCase().includes(searchTerm);
                    const matchesBudget = gift.total_price <= budget;
                    return matchesSearch && matchesBudget;
                });
                
                displaySearchResults(results);
                showLoading(false);
            }, 1000);
        }

        // Отображение результатов поиска
        function displaySearchResults(results) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">😔</div>
                        <h3>Ничего не найдено</h3>
                        <p>Попробуйте изменить параметры поиска</p>
                    </div>
                `;
                return;
            }
            
            results.forEach(gift => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-model">${gift.name}</div>
                        <div class="result-price">${gift.total_price} TON</div>
                    </div>
                    <div class="result-details">
                        ${gift.market} • ${getRarityText(gift.rarity)}
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="showGiftDetails('${gift.id}')">
                            ℹ️ Подробнее
                        </button>
                        <button class="action-btn" onclick="selectGift(${JSON.stringify(gift).replace(/"/g, '&quot;')})">
                            🎁 Выбрать
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Получение текста редкости
        function getRarityText(rarity) {
            const rarityMap = {
                'common': '⚪ Обычный',
                'rare': '🔵 Редкий', 
                'epic': '💜 Эпический',
                'legendary': '⭐ Легендарный'
            };
            return rarityMap[rarity] || rarity;
        }

        // Детали подарка
        function showGiftDetails(giftId) {
            const gift = realGifts.find(g => g.id === giftId);
            if (gift) {
                tg.showPopup({
                    title: `🎁 ${gift.name}`,
                    message: `💰 Цена: ${gift.total_price} TON\n🏪 Маркет: ${gift.market}\n⭐ Редкость: ${getRarityText(gift.rarity)}\n🎨 Особенности: ${gift.attributes.backdrop}, ${gift.attributes.symbol}`,
                    buttons: [{ type: 'ok' }]
                });
            }
        }

        // Очистка поиска
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('backdrop-input').value = '';
            document.getElementById('symbol-input').value = '';
            document.getElementById('budget-slider').value = 50;
            userBudget = 50;
            updateBudgetDisplays();
            document.getElementById('search-results').innerHTML = '';
        }

        // Установка бюджета
        function setBudget(amount) {
            userBudget = amount;
            document.getElementById('budget-setter').value = amount;
            updateBudgetDisplays();
        }

        // Сохранение бюджета
        function saveBudget() {
            showStatusMessage(`Бюджет установлен: ${userBudget} TON`, 'success');
            setTimeout(() => showScreen('main-screen'), 1000);
        }

        // Обновление отображения бюджета
        function updateBudgetDisplays() {
            document.getElementById('budget-amount').textContent = userBudget;
            document.getElementById('budget-display').textContent = userBudget;
        }

        // Показать статус сообщение
        function showStatusMessage(message, type = 'info') {
            const tempDiv = document.createElement('div');
            tempDiv.className = `status-message status-${type}`;
            tempDiv.textContent = message;
            tempDiv.style.position = 'fixed';
            tempDiv.style.top = '20px';
            tempDiv.style.left = '50%';
            tempDiv.style.transform = 'translateX(-50%)';
            tempDiv.style.zIndex = '1000';
            tempDiv.style.maxWidth = '90%';
            
            document.body.appendChild(tempDiv);
            
            setTimeout(() => {
                tempDiv.remove();
            }, 3000);
        }

        // Показать/скрыть загрузку
        function showLoading(show, text = "Загружаем данные...") {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('loading-text').textContent = text;
        }

        // Переключение темы
        function switchTheme() {
            const body = document.body;
            if (currentTheme === 'default') {
                body.classList.add('theme-light');
                currentTheme = 'light';
            } else if (currentTheme === 'light') {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                currentTheme = 'dark';
            } else {
                body.classList.remove('theme-dark');
                currentTheme = 'default';
            }
        }

        // Показать экран
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Слушатели событий
        document.getElementById('budget-slider').addEventListener('input', function() {
            userBudget = parseInt(this.value);
            document.getElementById('budget-amount').textContent = userBudget.toLocaleString();
        });

        document.getElementById('budget-setter').addEventListener('input', function() {
            userBudget = parseInt(this.value);
            document.getElementById('budget-display').textContent = userBudget.toLocaleString();
        });

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initApp);

        // Для демонстрации - симуляция активности
        setInterval(() => {
            realStats.todayOnline = Math.floor(Math.random() * 50) + 10;
            updateStatsDisplay();
        }, 30000);
    </script>
</body>
</html>
